# 智能家居安防系统开发文档

## 一、项目概述

### 1.1 项目名称
智能家居安防系统（Smart Home Security System）

### 1.2 项目背景
在进行了长达一学期的嵌入式学习后，我对开发板如何集成，驱动外设，以及如何实现系统功能有了更深入的理解，在此基础上，我希望通过多样的技术集成多种相关外设，制作一个对生活有所增益的设备。本项目基于STM32微控制器，实现了一个功能完整的智能家居安防系统，能够实时监测环境参数、检测入侵行为，并提供多种交互方式。

### 1.3 项目目标
开发一个基于STM32F103的智能家居安防系统，具备以下功能：
- 环境参数监测（温湿度）
- 红外入侵检测
- 多种系统模式切换
- 蜂鸣器报警提示
- OLED状态显示
- 串口通信与命令控制
- 数据存储与历史记录
- 实时时钟功能

## 二、硬件设计

### 2.1 硬件选型

| 组件 | 型号 | 功能描述 |
|------|------|----------|
| 微控制器 | STM32F103C8T6 | 核心控制单元 |
| 温湿度传感器 | DHT11 | 环境温湿度监测 |
| 红外传感器 | HC-SR501 | 人体红外检测 |
| 显示屏 | 0.96寸OLED | 状态信息显示 |
| 编码器 | EC11 | 系统模式切换控制 |
| 蜂鸣器 | 无源蜂鸣器 | 报警提示 |
| 存储芯片 | W25Q64 | 数据存储 |
| 实时时钟 | DS1302 | 时间管理 |

### 2.2 硬件连接图

```
STM32F103C8T6
├── DHT11传感器 (PA0)
├── HC-SR501红外传感器 (PA1)
├── OLED显示屏 (I2C接口: PB8-SCL, PB9-SDA)
├── EC11编码器 (PB0-A, PB1-B, PB10-SW)
├── 无源蜂鸣器 (PB5)
├── W25Q64存储芯片 (SPI接口: PA4-CS, PA5-SCK, PA6-MISO, PA7-MOSI)
├── DS1302实时时钟 (PC13-SCLK, PC14-I/O, PC15-CE)
└── USB转TTL模块 (USART1: PA9-TX, PA10-RX)
```

## 三、软件设计

### 3.1 系统架构

系统采用模块化设计，主要分为以下几个模块：

1. **核心控制模块**：main.c，负责系统初始化、主循环和模式切换
2. **传感器驱动模块**：DHT11.c、IR.c，负责传感器数据采集
3. **显示模块**：OLED.c，负责状态信息显示
4. **输入控制模块**：Encoder.c，负责编码器控制
5. **报警模块**：Buzzer.c，负责报警提示
6. **通信模块**：Serial.c，负责串口通信
7. **存储模块**：W25Q64.c，负责数据存储
8. **时钟模块**：RTC.c，负责时间管理

### 3.2 系统模式设计

系统设计了三种工作模式：

| 模式 | 描述 | 功能特点 |
|------|------|----------|
| MODE_ARMED | 布防模式 | 红外触发立即报警，温湿度超出阈值报警 |
| MODE_HOME | 居家模式 | 红外触发仅记录，不报警 |
| MODE_DEBUG | 调试模式 | 无报警功能，用于系统调试 |

### 3.3 核心功能实现

#### 3.3.1 温湿度监测

使用DHT11传感器进行温湿度监测，采用单总线协议进行数据通信。为提高数据可靠性，添加了错误处理和重试机制，最多重试5次。

#### 3.3.2 红外入侵检测

使用HC-SR501红外传感器检测人体活动，在布防模式下，红外触发立即报警，并记录报警数据。

#### 3.3.3 系统模式切换

支持三种模式切换方式：
- 编码器旋转（顺时针下一个模式，逆时针上一个模式）
- 编码器按键（按固定顺序循环切换）
- 串口命令（mode <0-2>）

#### 3.3.4 数据存储

使用W25Q64存储芯片记录系统状态和报警信息，每条记录包含时间戳、温度、湿度、系统模式和红外状态等信息。

#### 3.3.5 串口通信

实现了完整的串口命令控制系统，支持以下命令：
- help：显示帮助信息
- mode <0-2>：切换系统模式
- status：显示系统状态
- reset：重置系统
- threshold：设置温湿度阈值
- history：查看历史记录
- export：导出CSV格式数据
- clear_history：清除历史数据
- time：设置/查看时间

## 四、项目开发流程

### 4.1 开发环境搭建

1. 安装Keil MDK-ARM开发环境
2. 配置STM32F103C8T6芯片支持
3. 安装必要的驱动程序

### 4.2 系统初始化

1. 配置系统时钟
2. 初始化各硬件模块
3. 配置中断服务
4. 设置初始系统模式

### 4.3 功能模块开发

1. **串口通信模块**：实现printf重定向，确保调试通路畅通
2. **传感器驱动模块**：分别开发DHT11和红外传感器驱动
3. **显示模块**：实现OLED显示功能
4. **输入控制模块**：实现编码器旋转和按键功能
5. **报警模块**：实现蜂鸣器控制功能
6. **存储模块**：实现W25Q64数据存储功能
7. **时钟模块**：实现RTC实时时钟功能

### 4.4 系统集成与调试

1. 将各模块集成到主程序
2. 测试各功能模块的协同工作
3. 调试系统模式切换逻辑
4. 优化系统性能和稳定性

## 五、关键技术与解决方案

### 5.1 编码器控制优化

**问题**：编码器旋转检测不稳定，按键按下导致系统卡死

**解决方案**：
- 优化编码器旋转检测算法，降低防抖阈值，提高灵敏度
- 将按键防抖逻辑从中断处理函数移至主循环，避免长时间中断导致系统卡死
- 实现按键状态的软件防抖，使用计数器方式检测稳定的按键状态

### 5.2 温湿度传感器数据可靠性

**问题**：DHT11传感器数据读取不稳定

**解决方案**：
- 加入外接上拉电阻，确保工作电平的稳定
- 添加错误处理和重试机制，最多重试5次
- 即使所有重试都失败，也使用最后一次读取到的数据，确保系统不会因传感器问题而崩溃

### 5.3 系统模式切换逻辑

**问题**：系统模式切换逻辑复杂，容易出错

**解决方案**：
- 使用枚举类型定义系统模式，提高代码可读性
- 使用模运算实现模式的循环切换，简化代码逻辑
- 在模式切换时添加蜂鸣器提示，提高用户体验

## 六、开发总结与心得

### 6.1 项目总结

本项目成功实现了一个功能完整的智能家居安防系统，具备环境监测、入侵检测、模式切换、数据存储等功能。通过模块化设计和优化，系统性能稳定，用户体验良好。

项目中遇到了一些挑战，如编码器控制不稳定、传感器数据读取不可靠等，但通过仔细分析和优化，最终都得到了解决。这些经验对于今后的嵌入式系统开发具有重要的参考价值。

### 6.2 开发心得

我们在系统集成一个多功能嵌入式应用的过程中，许多之前在片面学习中显得单薄的知识与功能，在集成的过程中变得立体。其中，在开发的调试阶段，串口技术的应用是十分重要的，通过串口通信，可以方便地查看系统运行状态、调试代码、与外部设备进行交互，这协助我解决了不少问题。

与此同时，在针对不同外设进行集成的过程中，体验是十分不同的，这其中涉及各种不同的外设，包括编码器、红外传感器、蜂鸣器、OLED显示屏等。每个外设都有其特定的功能和接口，需要根据其要求进行配置和编程，这促使我在网上寻找学习资料，功能文件，开发的同时，对多种外设的集成，以及数据的交互、处理、显示有了深入的理解。

总而言之，对于具体的，多功能的，具有实际应用场景与考虑的嵌入式应用开发，能够让我们切实了解到嵌入式应用开发过程中需要考虑的种种条件与解决问题的方法，这与知识的深入无关，而体现了实践学习的重要性。


### 6.3 未来改进方向

1. 添加无线通信功能（如WiFi或蓝牙），实现远程控制
2. 增加更多传感器支持（如烟雾传感器、门窗磁传感器等）
3. 开发手机APP，提高用户交互体验
4. 优化电源管理，延长系统续航时间

## 七、附录

### 7.1 主要文件列表

| 文件路径 | 功能描述 |
|----------|----------|
| User/main.c | 系统主程序，负责核心逻辑控制 |
| Hardware/DHT11.c | DHT11温湿度传感器驱动 |
| Hardware/IR.c | 红外传感器驱动 |
| Hardware/OLED.c | OLED显示屏驱动 |
| Hardware/Encoder.c | 编码器驱动 |
| Hardware/Buzzer.c | 蜂鸣器驱动 |
| Hardware/Serial.c | 串口通信驱动 |
| Hardware/W25Q64.c | W25Q64存储芯片驱动 |
| Hardware/RTC.c | 实时时钟驱动 |

### 7.2 系统参数配置

| 参数 | 默认值 | 范围 | 功能描述 |
|------|--------|------|----------|
| 温度下限 | 10°C | 0-100°C | 温度报警下限阈值 |
| 温度上限 | 30°C | 0-100°C | 温度报警上限阈值 |
| 湿度下限 | 30% | 0-100% | 湿度报警下限阈值 |
| 湿度上限 | 80% | 0-100% | 湿度报警上限阈值 |
| 主循环周期 | 500ms | - | 系统主循环执行周期 |
| 温湿度读取周期 | 5秒 | - | 温湿度传感器读取周期 |
| OLED刷新周期 | 2秒 | - | OLED显示屏刷新周期 |
| 串口数据发送周期 | 2秒 | - | 串口数据发送周期 |