
### 📄 STM32智能家居安防系统开发需求文档 (串口精简版)

#### **1. 项目核心变更：使用串口替代Flash**
为了简化开发，本项目决定**不安装和使用W25QXX Flash芯片**，转而利用**CH340 USB转串口模块**作为核心通信与调试工具。所有系统状态、传感器数据和报警事件都将通过串口实时发送到电脑，便于监控和调试。

#### **2. 核心硬件清单 (最终版)**
| 模块 | 型号/说明 | 用途 |
| :--- | :--- | :--- |
| 微控制器 | STM32F103C8T6 | 系统主控 |
| 下载调试器 | ST-LINK | 程序下载与调试 |
| **串口模块** | **CH340 (或CH343)** | **连接电脑，进行数据通信与调试** |
| 显示 | 0.96寸 OLED (I2C, SSD1306) | 显示状态与数据 |
| 环境传感器 | DHT11 (温湿度) | 采集环境数据 |
| 安防传感器 | 反射式红外传感器 x1 | 检测人员移动 |
| 报警器 | 有源蜂鸣器 | 声报警 |
| 用户输入 | EC11旋转编码器 (带按键) | 切换模式、操作菜单 |
| 状态指示 | 板载LED (PC13) | 视觉状态指示 |

#### **3. 精简引脚分配表**
基于你的硬件和简化需求，最终引脚定义如下：

| 引脚 | 功能 | 外设 | 备注 |
| :--- | :--- | :--- | :--- |
| PA0 | 数据线 | DHT11 | 单总线协议 |
| PA1 | 信号输入 | 红外传感器 | 上拉输入，低电平触发 |
| PA8 | 信号输出 | 蜂鸣器 | 高电平驱动 |
| **PA9** | **TX** | **USART1** | **连接至CH340模块的RX引脚** |
| **PA10** | **RX** | **USART1** | **连接至CH340模块的TX引脚** |
| PA11 | PWM输出 | 舵机(SG90) | TIM1_CH4，已配置，可保留或停用 |
| PB0 | A相 | EC11编码器 | TIM3_CH3 (编码器模式) |
| PB1 | B相 | EC11编码器 | TIM3_CH4 (编码器模式) |
| PB10 | 按键 | EC11编码器 | 外部中断(EXTI10)，下降沿触发 |
| PB6 | SCL | OLED (I2C1) | |
| PB7 | SDA | OLED (I2C1) | |
| PC13 | 输出 | 板载LED | |

> **硬件接线关键**：务必确保**STM32的TX(PA9)接CH340的RX**，**STM32的RX(PA10)接CH340的TX**，并且**两者GND相连**。CH340模块的VCC可接3.3V或5V，需与STM32逻辑电平匹配。

#### **4. 软件功能设计**
##### **4.1 工作模式**
系统仅保留三种明确模式，通过编码器切换：
*   **布防模式**：红外传感器启用，触发后立即声光报警，并通过串口发送紧急事件。
*   **居家模式**：红外传感器启用，触发后仅记录和串口通知，不启动声音报警。
*   **调试模式**：传感器持续检测，所有数据通过串口输出，方便开发者监测。

##### **4.2 串口通信协议 (核心)**
由于取消了Flash，所有数据将通过串口发送。设计一个简单易解析的协议：
*   **数据格式**：`[类型标识][数据内容]\n` (以换行符结束)
*   **波特率**：115200
*   **示例**：
    *   周期数据：`[DATA]Temp:25.6,Humi:45%,IR:0\n`
    *   报警事件：`[ALARM]INTRUSION!\n`
    *   模式切换：`[MODE]ARMED\n`

##### **4.3 系统工作流程**
```c
初始化();
显示欢迎界面();
串口发送启动信息();

while(1) {
    1. 扫描编码器，处理用户操作（切换模式、菜单）；
    2. 读取DHT11温湿度；
    3. 读取红外传感器状态；
    4. 根据当前模式执行安防逻辑判断；
    5. 刷新OLED显示（系统状态、传感器读数）；
    6. 将关键数据按协议格式通过串口发送至电脑；
    7. 执行延时，进入下一循环。
}
```

#### **5. 开发准备工作**
1.  **安装驱动**：在电脑上安装CH340/CH343的USB转串口驱动程序。
2.  **准备工具**：在电脑上准备一个串口调试助手软件（如Putty、SSCOM等），用于接收和查看STM32发来的数据。

#### **6. 预期演示效果**
1.  **基础信息显示**：OLED屏实时显示温湿度、系统模式。
2.  **串口数据监控**：电脑上的串口助手持续显示环境数据流。
3.  **入侵报警演示**：
    *   在“布防模式”下，用手遮挡红外传感器。
    *   **硬件响应**：蜂鸣器鸣叫，LED快闪。
    *   **软件响应**：OLED显示警报，串口助手收到 `[ALARM]INTRUSION!` 信息。
4.  **模式切换演示**：旋转并按下EC11编码器，切换系统模式，OLED和串口输出同步更新。

### 💡 给AI开发者的建议
- **启动顺序**：建议AI从建立工程、配置串口、实现`printf`重定向开始，确保调试通路畅通，然后逐个添加传感器驱动。
- **调试策略**：每完成一个传感器驱动（如DHT11），立即通过串口打印其读数进行验证，这样可以快速定位问题。
- **简化处理**：将复杂功能（如历史记录存储）转化为通过串口实时上报，由上位机软件处理，大大减轻STM32的编程负担。

这份文档将项目聚焦于核心的传感、报警和通信功能，移除了复杂的存储管理，使开发和调试路径更清晰。如果你希望针对文档中的某个部分（如串口协议细节、EC11驱动代码）进行更深入的探讨，我可以随时提供更详细的说明。